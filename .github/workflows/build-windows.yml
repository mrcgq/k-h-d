name: Build Windows Client

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    # 1. 设置 MinGW 编译环境
    - name: Set up MinGW
      uses: egor-tensin/setup-mingw@v2
      with:
        platform: x64

    # 2. 编译资源文件 (resource.rc -> resource.o)
    # 注意：确保您的仓库里有 resource.rc 和 logo.ico
    - name: Compile Resources
      run: |
        windres -i resource.rc -o resource.o
      continue-on-error: false

    # 3. 编译主程序 (main.c -> xlink-client.exe)
    # 使用了 -mwindows 参数以隐藏控制台窗口
    # 使用了 -static 确保不需要额外的 DLL
    # 强制指定字符集为 UTF-8 输入，GBK 执行 (适配中文 Windows)
    - name: Compile C Client
      run: |
        gcc -static -Wall -Wextra -std=c99 -finput-charset=UTF-8 -fexec-charset=GBK -Os -s -o xlink-client.exe main.c resource.o -luser32 -lkernel32 -lcomctl32 -lgdi32 -lcrypt32 -lws2_32 -lwininet -mwindows

    # 4. 上传编译产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: xlink-client-windows
        path: xlink-client.exe
